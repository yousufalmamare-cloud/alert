<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>InformaCast Pro - Push Notifications</title>
    
    <!-- iOS specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="InformaCast">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/893/893257.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22InformaCast%20Pro%22%2C%22short_name%22%3A%22InformaCast%22%2C%22start_url%22%3A%22%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a2e42%22%2C%22theme_color%22%3A%22%230a5c8c%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F893%2F893257.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(145deg, #0a2e42, #0c384f);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 16px;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 24px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        h1 {
            text-align: center;
            color: #ffd700;
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #b0d4e8;
            margin-bottom: 30px;
        }
        .status-box {
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border-radius: 15px;
            margin: 8px 0;
        }
        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .status-icon.green { background: #4caf50; }
        .status-icon.red { background: #ff4444; }
        .status-icon.yellow { background: #ffaa33; }
        .status-text {
            flex: 1;
            font-weight: 500;
        }
        .setup-instructions {
            background: rgba(255,215,0,0.1);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }
        .setup-instructions ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        .setup-instructions li {
            margin: 10px 0;
            color: #e0e0e0;
        }
        .setup-instructions .highlight {
            color: #ffd700;
            font-weight: bold;
        }
        .alert-creator {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 20px;
            margin: 25px 0;
        }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 16px;
            margin: 15px 0;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: #ffd700;
        }
        .severity-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .severity-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s;
        }
        .severity-btn.active {
            opacity: 1;
            transform: scale(1.02);
            box-shadow: 0 0 15px currentColor;
        }
        .critical-btn { background: #ff4444; color: white; }
        .warning-btn { background: #ffaa33; color: black; }
        .info-btn { background: #4caf50; color: white; }
        .send-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(145deg, #ffd700, #ffb300);
            border: none;
            border-radius: 30px;
            color: #0a2e42;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.3s;
        }
        .send-btn:hover {
            transform: translateY(-2px);
        }
        .alerts-section {
            margin-top: 30px;
        }
        .alert-card {
            background: rgba(255,255,255,0.1);
            border-left: 5px solid;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }
        .test-result {
            text-align: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 15px;
            font-weight: bold;
        }
        .test-success {
            background: rgba(76,175,80,0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }
        .test-fail {
            background: rgba(255,68,68,0.2);
            color: #ff8888;
            border: 1px solid #ff4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¢ InformaCast Pro</h1>
        <p class="subtitle">Push Notifications That Ring Your Phone</p>

        <!-- Status Dashboard -->
        <div class="status-box">
            <div class="status-item">
                <div class="status-icon" id="iosIcon">üì±</div>
                <div class="status-text" id="iosStatus">Checking device...</div>
            </div>
            <div class="status-item">
                <div class="status-icon" id="installIcon">üì≤</div>
                <div class="status-text" id="installStatus">Checking installation...</div>
            </div>
            <div class="status-item">
                <div class="status-icon" id="notifyIcon">üîî</div>
                <div class="status-text" id="notifyStatus">Checking permissions...</div>
            </div>
        </div>

        <!-- CRITICAL: iOS Setup Instructions -->
        <div class="setup-instructions" id="setupInstructions">
            <h3 style="color: #ffd700; margin-bottom: 15px;">üì± iOS SETUP REQUIRED - Follow exactly:</h3>
            <ol>
                <li><span class="highlight">1.</span> Open this page in <strong>SAFARI</strong> (not Chrome)</li>
                <li><span class="highlight">2.</span> Tap <strong>Share button</strong> (square with arrow)</li>
                <li><span class="highlight">3.</span> Scroll down and tap <strong>"Add to Home Screen"</strong></li>
                <li><span class="highlight">4.</span> Tap <strong>"Add"</strong> in top right corner</li>
                <li><span class="highlight">5.</span> <strong>CLOSE SAFARI</strong> completely (swipe up)</li>
                <li><span class="highlight">6.</span> Open app from <strong>Home Screen</strong> (new icon)</li>
                <li><span class="highlight">7.</span> Tap <strong>"Allow"</strong> when notification prompt appears</li>
            </ol>
        </div>

        <!-- Test Result Display -->
        <div id="testResult" style="display: none;"></div>

        <!-- Alert Creator -->
        <div class="alert-creator">
            <h3 style="margin-bottom: 15px;">‚úçÔ∏è Create Test Alert</h3>
            <textarea id="messageInput" placeholder="Enter your test message..." rows="3">This is a test notification - your phone should ring!</textarea>
            
            <div class="severity-selector" id="severitySelector">
                <button class="severity-btn critical-btn active" data-severity="critical">üî¥ CRITICAL</button>
                <button class="severity-btn warning-btn" data-severity="warning">üü† WARNING</button>
                <button class="severity-btn info-btn" data-severity="info">üîµ INFO</button>
            </div>

            <button id="sendBtn" class="send-btn">
                üì¢ SEND TEST ALERT
            </button>
        </div>

        <!-- Recent Alerts -->
        <div class="alerts-section">
            <h3>üìã Recent Alerts</h3>
            <div id="alertsList">
                <p style="text-align: center; opacity: 0.5;">Loading...</p>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION - UPDATE WITH YOUR SUPABASE INFO
        // =============================================
        const SUPABASE_URL = 'https://zwhbpqhrlkxhgrhmgyvx.supabase.co';  // REPLACE THIS
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3aGJwcWhybGt4aGdyaG1neXZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODUzMDUsImV4cCI6MjA4NjY2MTMwNX0.jPcxT1wZMCbPFQkK4qWhLfQkO8MtvVPlyga1i2cto6o';                 // REPLACE THIS

        // =============================================
        // SERVICE WORKER (for push notifications)
        // =============================================
        const swCode = `
        self.addEventListener('install', (event) => {
            self.skipWaiting();
        });

        self.addEventListener('activate', (event) => {
            event.waitUntil(clients.claim());
        });

        self.addEventListener('push', (event) => {
            if (!event.data) return;
            
            const data = event.data.json();
            
            let title = 'üì¢ INFO';
            let options = {
                body: data.message || 'Test notification',
                icon: 'https://cdn-icons-png.flaticon.com/512/893/893257.png',
                badge: 'https://cdn-icons-png.flaticon.com/512/893/893257.png',
                vibrate: [200, 100, 200],
                requireInteraction: true,
                silent: false,
                tag: 'alert-' + Date.now()
            };

            if (data.severity === 'critical') {
                title = 'üö® CRITICAL ALERT';
                options.vibrate = [500, 200, 500, 200, 500];
            } else if (data.severity === 'warning') {
                title = '‚ö†Ô∏è WARNING';
                options.vibrate = [300, 100, 300];
            }

            event.waitUntil(
                self.registration.showNotification(title, options)
            );
        });

        self.addEventListener('notificationclick', (event) => {
            event.notification.close();
            event.waitUntil(
                clients.matchAll({ type: 'window' }).then(clientList => {
                    if (clientList.length > 0) {
                        return clientList[0].focus();
                    }
                    return clients.openWindow('/');
                })
            );
        });
        `;

        // =============================================
        // APP STATE
        // =============================================
        let currentSeverity = 'critical';
        let swRegistration = null;
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        let isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        // =============================================
        // UPDATE STATUS DASHBOARD
        // =============================================
        function updateStatus() {
            // iOS Device Check
            const iosIcon = document.getElementById('iosIcon');
            const iosStatus = document.getElementById('iosStatus');
            if (isIOS) {
                iosIcon.className = 'status-icon green';
                iosIcon.textContent = '‚úÖ';
                iosStatus.textContent = '‚úì iOS Device Detected';
            } else {
                iosIcon.className = 'status-icon red';
                iosIcon.textContent = '‚ùå';
                iosStatus.textContent = 'Not iOS - Push may not work';
            }

            // Installation Check
            const installIcon = document.getElementById('installIcon');
            const installStatus = document.getElementById('installStatus');
            if (isStandalone) {
                installIcon.className = 'status-icon green';
                installIcon.textContent = '‚úÖ';
                installStatus.textContent = '‚úì Installed to Home Screen';
                document.getElementById('setupInstructions').style.display = 'none';
            } else if (isIOS) {
                installIcon.className = 'status-icon red';
                installIcon.textContent = '‚ùå';
                installStatus.textContent = 'NOT INSTALLED - Follow steps above';
                document.getElementById('setupInstructions').style.display = 'block';
            } else {
                installIcon.className = 'status-icon yellow';
                installIcon.textContent = '‚ö†Ô∏è';
                installStatus.textContent = 'Install recommended';
            }

            // Notification Permission
            const notifyIcon = document.getElementById('notifyIcon');
            const notifyStatus = document.getElementById('notifyStatus');
            if (Notification.permission === 'granted') {
                notifyIcon.className = 'status-icon green';
                notifyIcon.textContent = '‚úÖ';
                notifyStatus.textContent = '‚úì Notifications Allowed';
            } else if (Notification.permission === 'denied') {
                notifyIcon.className = 'status-icon red';
                notifyIcon.textContent = '‚ùå';
                notifyStatus.textContent = 'Notifications Blocked';
            } else {
                notifyIcon.className = 'status-icon yellow';
                notifyIcon.textContent = '‚ö†Ô∏è';
                notifyStatus.textContent = 'Permission Needed';
            }
        }

        // =============================================
        // SETUP SERVICE WORKER
        // =============================================
        async function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    swRegistration = await navigator.serviceWorker.register(url, { scope: '/' });
                    
                    // Request permission if needed
                    if (Notification.permission === 'default') {
                        await Notification.requestPermission();
                    }
                    
                    updateStatus();
                } catch (error) {
                    console.log('Service Worker error:', error);
                }
            }
        }

        // =============================================
        // LOAD ALERTS FROM SUPABASE
        // =============================================
        async function loadAlerts() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/alerts?order=created_at.desc&limit=10`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch');
                
                const alerts = await response.json();
                displayAlerts(alerts);
            } catch (error) {
                // Show demo data if Supabase not configured
                displayAlerts([
                    {
                        id: '1',
                        message: '‚ö†Ô∏è Please update SUPABASE_URL and SUPABASE_ANON_KEY in the code',
                        severity: 'warning',
                        sender: 'system',
                        created_at: new Date().toISOString()
                    }
                ]);
            }
        }

        function displayAlerts(alerts) {
            const list = document.getElementById('alertsList');
            if (!alerts || alerts.length === 0) {
                list.innerHTML = '<p style="text-align: center; opacity: 0.5;">No alerts yet</p>';
                return;
            }
            
            list.innerHTML = alerts.map(alert => `
                <div class="alert-card" style="border-left-color: ${alert.severity === 'critical' ? '#ff4444' : alert.severity === 'warning' ? '#ffaa33' : '#4caf50'}">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>${alert.severity.toUpperCase()}</strong>
                        <small>${new Date(alert.created_at).toLocaleTimeString()}</small>
                    </div>
                    <p style="margin: 5px 0;">${escapeHtml(alert.message)}</p>
                    <small>From: ${escapeHtml(alert.sender)}</small>
                </div>
            `).join('');
        }

        // =============================================
        // SEND TEST ALERT
        // =============================================
        async function sendAlert() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                showTestResult('Please enter a message', false);
                return;
            }

            // Show sending status
            const sendBtn = document.getElementById('sendBtn');
            const originalText = sendBtn.textContent;
            sendBtn.textContent = '‚è≥ SENDING...';
            sendBtn.disabled = true;

            try {
                // Send to Supabase
                const response = await fetch(`${SUPABASE_URL}/rest/v1/alerts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        message: message,
                        severity: currentSeverity,
                        sender: 'web-user'
                    })
                });

                if (!response.ok) throw new Error('Failed to send');

                // Show local notification
                if (swRegistration && Notification.permission === 'granted') {
                    await swRegistration.showNotification(
                        currentSeverity === 'critical' ? 'üö® TEST CRITICAL' : 
                        currentSeverity === 'warning' ? '‚ö†Ô∏è TEST WARNING' : 'üì¢ TEST INFO',
                        {
                            body: message,
                            icon: 'https://cdn-icons-png.flaticon.com/512/893/893257.png',
                            vibrate: currentSeverity === 'critical' ? [500,200,500] : [200,100,200],
                            requireInteraction: true,
                            tag: 'test-' + Date.now()
                        }
                    );
                    
                    showTestResult('‚úÖ Alert sent! Check your notifications!', true);
                } else {
                    showTestResult('‚úÖ Alert saved to database (but notifications not enabled)', true);
                }

                document.getElementById('messageInput').value = '';
                await loadAlerts();

            } catch (error) {
                console.error('Send error:', error);
                showTestResult('‚ùå Failed to send. Check Supabase configuration.', false);
            } finally {
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        function showTestResult(message, isSuccess) {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.className = `test-result ${isSuccess ? 'test-success' : 'test-fail'}`;
            resultDiv.textContent = message;
            
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================
        document.querySelectorAll('.severity-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSeverity = btn.dataset.severity;
            });
        });

        document.getElementById('sendBtn').addEventListener('click', sendAlert);

        // =============================================
        // INITIALIZATION
        // =============================================
        window.addEventListener('load', async () => {
            await setupServiceWorker();
            await loadAlerts();
            updateStatus();

            // Monitor installation status changes
            if (isIOS) {
                setInterval(() => {
                    const newStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
                    if (newStandalone !== isStandalone) {
                        isStandalone = newStandalone;
                        updateStatus();
                    }
                }, 1000);
            }
        });

        // Handle visibility change (when app returns to foreground)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                loadAlerts();
                updateStatus();
            }
        });
    </script>
</body>
</html>
