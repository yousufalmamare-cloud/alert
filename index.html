<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>InformaCast - Push Notification System</title>
    
    <!-- Fixed Manifest - Proper JSON format -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Proper meta tags for PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a5c8c">
    
    <!-- Inline fallback manifest if file doesn't exist -->
    <script>
        // Create manifest if it doesn't exist
        if (!window.location.href.includes('manifest.json')) {
            const manifest = {
                name: "InformaCast",
                short_name: "InformaCast",
                start_url: window.location.href.split('#')[0].split('?')[0],
                display: "standalone",
                background_color: "#0a2e42",
                theme_color: "#0a5c8c",
                icons: [{
                    src: "https://cdn-icons-png.flaticon.com/512/893/893257.png",
                    sizes: "512x512",
                    type: "image/png"
                }]
            };
            
            // Create manifest link if needed
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                manifestLink.href = 'data:application/manifest+json,' + encodeURIComponent(JSON.stringify(manifest));
            }
        }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
        }
        .config-section input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-family: monospace;
        }
        .config-section button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }
        .status-bar {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .status-item:last-child { border-bottom: none; }
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .dot.green { background: #28a745; box-shadow: 0 0 10px #28a745; }
        .dot.yellow { background: #ffc107; box-shadow: 0 0 10px #ffc107; }
        .dot.red { background: #dc3545; box-shadow: 0 0 10px #dc3545; }
        .alert-form {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            resize: vertical;
        }
        textarea:focus { outline: none; border-color: #667eea; }
        .severity-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .severity-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s;
        }
        .severity-btn.active {
            opacity: 1;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .critical { background: #dc3545; color: white; }
        .warning { background: #ffc107; color: #333; }
        .info { background: #17a2b8; color: white; }
        .send-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .send-btn:hover { transform: translateY(-2px); }
        .send-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        .alerts-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .alert-item {
            background: white;
            border-left: 5px solid;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .alert-critical { border-left-color: #dc3545; }
        .alert-warning { border-left-color: #ffc107; }
        .alert-info { border-left-color: #17a2b8; }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.3s;
            z-index: 9999;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .config-hint {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¢ InformaCast</h1>
        <p class="subtitle">Push Notifications via Supabase + GitHub</p>

        <!-- Configuration Section (visible if not set) -->
        <div class="config-section" id="configSection">
            <h3 style="margin-bottom: 10px;">‚öôÔ∏è Configuration Required</h3>
            <p>Enter your Supabase credentials:</p>
            <input type="text" id="configUrl" placeholder="Supabase URL (e.g., https://xyz.supabase.co)" value="">
            <input type="text" id="configKey" placeholder="Supabase Anon Key" value="">
            <button id="saveConfigBtn">Save Configuration</button>
            <div class="config-hint">Find these in Supabase ‚Üí Project Settings ‚Üí API</div>
        </div>

        <!-- Status Dashboard -->
        <div class="status-bar" id="statusBar">
            <div class="status-item">
                <span class="dot" id="supabaseDot"></span>
                <span>Supabase:</span>
                <span id="supabaseStatus">Not configured</span>
            </div>
            <div class="status-item">
                <span class="dot" id="pushDot"></span>
                <span>Notifications:</span>
                <span id="pushStatus">Checking...</span>
            </div>
            <div class="status-item">
                <span class="dot" id="deviceDot"></span>
                <span>Device:</span>
                <span id="deviceStatus">Detecting...</span>
            </div>
        </div>

        <!-- Alert Form -->
        <div class="alert-form">
            <h3 style="margin-bottom: 15px;">Create New Alert</h3>
            <textarea id="messageInput" placeholder="Enter alert message..." rows="3">Test push notification from GitHub!</textarea>
            
            <div class="severity-selector" id="severitySelector">
                <button class="severity-btn critical active" data-severity="critical">üî¥ CRITICAL</button>
                <button class="severity-btn warning" data-severity="warning">üü† WARNING</button>
                <button class="severity-btn info" data-severity="info">üîµ INFO</button>
            </div>

            <button id="sendBtn" class="send-btn" disabled>
                üì¢ SEND PUSH NOTIFICATION
            </button>
        </div>

        <!-- Recent Alerts -->
        <div class="alerts-list">
            <h3 style="margin-bottom: 15px;">Recent Alerts</h3>
            <div id="alertsFeed">
                <p style="text-align: center; color: #999;">Configure Supabase to load alerts</p>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage">Alert sent!</span>
    </div>

    <script>
        // =============================================
        // CONFIGURATION - LOADED FROM LOCAL STORAGE
        // =============================================
        let SUPABASE_URL = localStorage.getItem('https://zwhbpqhrlkxhgrhmgyvx.supabase.co') || '';
        let SUPABASE_ANON_KEY = localStorage.getItem('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3aGJwcWhybGt4aGdyaG1neXZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODUzMDUsImV4cCI6MjA4NjY2MTMwNX0.jPcxT1wZMCbPFQkK4qWhLfQkO8MtvVPlyga1i2cto6o') || '';
        
        // =============================================
        // APP STATE
        // =============================================
        let currentSeverity = 'critical';
        let isConfigured = false;

        // =============================================
        // SHOW/HIDE CONFIG SECTION
        // =============================================
        function updateConfigDisplay() {
            const configSection = document.getElementById('configSection');
            if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                configSection.style.display = 'none';
                document.getElementById('sendBtn').disabled = false;
                isConfigured = true;
                checkSupabase();
                loadAlerts();
            } else {
                configSection.style.display = 'block';
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('supabaseStatus').innerHTML = '‚ùå Not configured';
                document.getElementById('supabaseDot').className = 'dot red';
            }
        }

        // =============================================
        // SAVE CONFIGURATION
        // =============================================
        document.getElementById('saveConfigBtn').addEventListener('click', () => {
            const url = document.getElementById('configUrl').value.trim();
            const key = document.getElementById('configKey').value.trim();
            
            if (url && key) {
                SUPABASE_URL = url;
                SUPABASE_ANON_KEY = key;
                localStorage.setItem('supabaseUrl', url);
                localStorage.setItem('supabaseKey', key);
                updateConfigDisplay();
            } else {
                showToast('Please enter both URL and Key', 'error');
            }
        });

        // =============================================
        // CHECK SUPABASE CONNECTION
        // =============================================
        async function checkSupabase() {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return false;
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/alerts?limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    document.getElementById('supabaseStatus').innerHTML = '‚úÖ Connected';
                    document.getElementById('supabaseDot').className = 'dot green';
                    return true;
                } else if (response.status === 401) {
                    document.getElementById('supabaseStatus').innerHTML = '‚ùå Invalid Key';
                    document.getElementById('supabaseDot').className = 'dot red';
                    showToast('Invalid Supabase key', 'error');
                    return false;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('supabaseStatus').innerHTML = '‚ùå Connection Failed';
                document.getElementById('supabaseDot').className = 'dot red';
                return false;
            }
        }

        // =============================================
        // CHECK NOTIFICATION PERMISSION
        // =============================================
        async function checkNotificationPermission() {
            if (!('Notification' in window)) {
                document.getElementById('pushStatus').innerHTML = '‚ùå Not supported';
                document.getElementById('pushDot').className = 'dot red';
                return;
            }

            if (Notification.permission === 'granted') {
                document.getElementById('pushStatus').innerHTML = '‚úÖ Allowed';
                document.getElementById('pushDot').className = 'dot green';
            } else if (Notification.permission === 'denied') {
                document.getElementById('pushStatus').innerHTML = '‚ùå Blocked';
                document.getElementById('pushDot').className = 'dot red';
            } else {
                document.getElementById('pushStatus').innerHTML = '‚ö†Ô∏è Click Allow when prompted';
                document.getElementById('pushDot').className = 'dot yellow';
                
                // Request permission
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    document.getElementById('pushStatus').innerHTML = '‚úÖ Allowed';
                    document.getElementById('pushDot').className = 'dot green';
                }
            }
        }

        // =============================================
        // LOAD ALERTS FROM SUPABASE
        // =============================================
        async function loadAlerts() {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) return;
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/alerts?order=created_at.desc&limit=10`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch');
                
                const alerts = await response.json();
                displayAlerts(alerts);
            } catch (error) {
                document.getElementById('alertsFeed').innerHTML = '<p style="text-align:center;color:#999;">Unable to load alerts</p>';
            }
        }

        function displayAlerts(alerts) {
            const feed = document.getElementById('alertsFeed');
            
            if (!alerts || alerts.length === 0) {
                feed.innerHTML = '<p style="text-align:center;color:#999;">No alerts yet</p>';
                return;
            }

            feed.innerHTML = alerts.map(alert => {
                const severityClass = alert.severity === 'critical' ? 'alert-critical' : 
                                     alert.severity === 'warning' ? 'alert-warning' : 'alert-info';
                
                return `
                    <div class="alert-item ${severityClass}">
                        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                            <strong>${alert.severity.toUpperCase()}</strong>
                            <small>${new Date(alert.created_at).toLocaleTimeString()}</small>
                        </div>
                        <p style="margin:5px 0;">${escapeHtml(alert.message)}</p>
                        <small>From: ${escapeHtml(alert.sender)}</small>
                    </div>
                `;
            }).join('');
        }

        // =============================================
        // SEND ALERT TO SUPABASE
        // =============================================
        async function sendAlert() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                showToast('Please enter a message', 'error');
                return;
            }

            const sendBtn = document.getElementById('sendBtn');
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = '‚è≥ SENDING...';
            sendBtn.disabled = true;

            try {
                // Save to Supabase
                const response = await fetch(`${SUPABASE_URL}/rest/v1/alerts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        message: message,
                        severity: currentSeverity,
                        sender: 'web-user'
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                // Show local notification if permission granted
                if (Notification.permission === 'granted') {
                    const title = currentSeverity === 'critical' ? 'üö® CRITICAL' :
                                 currentSeverity === 'warning' ? '‚ö†Ô∏è WARNING' : 'üì¢ INFO';
                    
                    new Notification(title, {
                        body: message,
                        icon: 'https://cdn-icons-png.flaticon.com/512/893/893257.png'
                    });
                }

                showToast('‚úÖ Alert sent successfully!');
                document.getElementById('messageInput').value = '';
                await loadAlerts();

            } catch (error) {
                console.error('Send error:', error);
                showToast(`‚ùå ${error.message}`, 'error');
            } finally {
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = false;
            }
        }

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.style.backgroundColor = type === 'success' ? '#28a745' : '#dc3545';
            toast.style.color = 'white';
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function getDeviceType() {
            const ua = navigator.userAgent;
            if (/iPhone|iPad|iPod/i.test(ua)) return 'üì± iOS';
            if (/Android/i.test(ua)) return 'üì± Android';
            return 'üíª Desktop';
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================
        document.querySelectorAll('.severity-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSeverity = btn.dataset.severity;
            });
        });

        document.getElementById('sendBtn').addEventListener('click', sendAlert);

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (isConfigured) sendAlert();
            }
        });

        // Pre-fill config if values exist
        if (SUPABASE_URL) document.getElementById('configUrl').value = SUPABASE_URL;
        if (SUPABASE_ANON_KEY) document.getElementById('configKey').value = SUPABASE_ANON_KEY;

        // =============================================
        // INITIALIZATION
        // =============================================
        window.addEventListener('load', async () => {
            // Display device type
            document.getElementById('deviceStatus').innerHTML = getDeviceType();
            document.getElementById('deviceDot').className = 'dot green';
            
            // Update config display
            updateConfigDisplay();
            
            // Check notification permission
            await checkNotificationPermission();
            
            // Load alerts if configured
            if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                await loadAlerts();
            }
            
            // Auto-refresh every 10 seconds
            setInterval(() => {
                if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                    loadAlerts();
                }
            }, 10000);
        });
    </script>
</body>
</html>
