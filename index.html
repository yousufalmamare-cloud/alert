<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>InformaCast ¬∑ professional alert system</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f5fa;
            color: #1a2b3e;
            line-height: 1.5;
            padding: 24px 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .app-container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 32px;
            box-shadow: 0 20px 40px -12px rgba(0,32,64,0.15);
            padding: 32px 28px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo i {
            font-size: 30px;
            color: #0a5c8c;
            background: #e3f0fa;
            padding: 12px;
            border-radius: 18px;
        }

        .logo h1 {
            font-weight: 700;
            font-size: 1.9rem;
            letter-spacing: -0.02em;
            color: #0a2e4a;
        }

        .badge {
            background: #deecf7;
            color: #0a4b78;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-creator {
            background: white;
            border-radius: 28px;
            padding: 28px;
            margin-bottom: 36px;
            border: 1px solid #d0e0eb;
            box-shadow: 0 6px 0 #d9e2ec;
        }

        .creator-title {
            display: flex;
            gap: 12px;
            align-items: center;
            font-weight: 600;
            color: #1e4a62;
            margin-bottom: 24px;
            font-size: 1.25rem;
        }

        .input-field {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid #e3eef6;
            border-radius: 20px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            background: #fafdff;
            transition: all 0.15s;
            margin-bottom: 20px;
            resize: vertical;
        }

        .input-field:focus {
            border-color: #2a7faa;
            outline: none;
            box-shadow: 0 0 0 4px rgba(42,127,170,0.08);
        }

        .alert-type-selector {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .type-option {
            flex: 1 1 140px;
            background: white;
            border: 2px solid #d3e2ed;
            border-radius: 40px;
            padding: 14px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            color: #2c4e66;
            transition: all 0.1s;
            cursor: pointer;
        }

        .type-option.selected {
            background: #0a5c8c;
            border-color: #0a5c8c;
            color: white;
        }

        .btn-send {
            width: 100%;
            background: #0a4b6e;
            border: none;
            border-radius: 50px;
            padding: 18px 20px;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border-bottom: 4px solid #052c3f;
            transition: all 0.1s;
            cursor: pointer;
        }

        .btn-send:hover {
            background: #0e5f88;
            border-bottom-width: 2px;
            transform: translateY(2px);
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0 20px 8px;
        }

        .feed-header h3 {
            font-weight: 650;
            color: #173f56;
            display: flex;
            gap: 10px;
            font-size: 1.3rem;
        }

        .refresh-btn {
            background: transparent;
            border: none;
            color: #3b6a89;
            font-size: 1.2rem;
            padding: 10px 14px;
            border-radius: 30px;
            cursor: pointer;
        }

        .refresh-btn:hover {
            background: #e1ecf3;
        }

        .alert-card {
            background: white;
            border-radius: 24px;
            padding: 22px;
            margin-bottom: 18px;
            border-left: 10px solid;
            box-shadow: 0 6px 0 #e3ecf2, 0 12px 20px -12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            word-break: break-word;
        }

        .alert-critical { border-left-color: #bc2c3c; background: #fff8f9; }
        .alert-warning { border-left-color: #dc7a1e; background: #fffcf5; }
        .alert-info { border-left-color: #1f7ea3; background: #f6fcff; }

        .alert-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .alert-badge {
            font-weight: 700;
            padding: 6px 18px;
            border-radius: 40px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .critical-badge { background: #bc2c3c; color: white; }
        .warning-badge { background: #dc7a1e; color: white; }
        .info-badge { background: #1f7ea3; color: white; }

        .alert-timestamp {
            margin-left: auto;
            font-size: 0.8rem;
            color: #4d6a80;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #eef5f9;
            padding: 5px 16px;
            border-radius: 30px;
        }

        .alert-message {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 8px 0 12px 0;
            color: #0a2433;
            line-height: 1.45;
        }

        .alert-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            color: #3c6072;
            font-size: 0.9rem;
        }

        .sender {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #ecf3f8;
            padding: 6px 18px;
            border-radius: 40px;
        }

        .empty-state {
            text-align: center;
            padding: 50px 30px;
            background: #f8fcff;
            border-radius: 40px;
            color: #4d738b;
            border: 2px dashed #bed1df;
        }

        .toast-message {
            background: #0a2e42;
            color: white;
            padding: 16px 28px;
            border-radius: 60px;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 20px;
            animation: fadeIn 0.3s;
            width: 100%;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
        }

        .hidden { display: none; }

        @media (max-width: 480px) {
            .app-container { padding: 24px 18px; }
            .logo h1 { font-size: 1.6rem; }
            .alert-creator { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="logo">
                <i class="fas fa-bullhorn"></i>
                <h1>InformaCast</h1>
            </div>
            <div class="badge">
                <i class="fas fa-shield"></i> enterprise
            </div>
        </div>

        <div class="alert-creator">
            <div class="creator-title">
                <i class="fas fa-bolt" style="color: #0a5c8c;"></i> 
                Compose broadcast
            </div>
            <textarea id="alertMessage" class="input-field" placeholder="Write alert message..." rows="2"></textarea>
            
            <div class="alert-type-selector" id="severitySelector">
                <div class="type-option selected" data-type="critical">
                    <i class="fas fa-exclamation-triangle"></i> Critical
                </div>
                <div class="type-option" data-type="warning">
                    <i class="fas fa-exclamation"></i> Warning
                </div>
                <div class="type-option" data-type="info">
                    <i class="fas fa-info-circle"></i> Info
                </div>
            </div>

            <button id="publishAlertBtn" class="btn-send">
                <i class="fas fa-paper-plane"></i> Publish alert
            </button>
            <div id="pushToast" class="hidden toast-message" style="margin-top: 24px;"></div>
        </div>

        <div class="feed-header">
            <h3><i class="fas fa-broadcast-tower"></i> Live alerts</h3>
            <button id="refreshFeedBtn" class="refresh-btn" title="refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <div id="alertFeed">
            <div class="empty-state">
                <i class="fas fa-water" style="font-size: 2.8rem; margin-bottom: 18px; opacity: 0.6;"></i>
                <p style="font-size: 1.2rem; font-weight: 600;">No active broadcasts</p>
                <p style="margin-top: 10px;">Alerts appear instantly, even when app is closed.</p>
            </div>
        </div>
    </div>

    <script type="module">
        // =============================================
        // INFORMACAST FRONTEND ‚Äì ONE FILE
        // CONNECTS TO SUPABASE BACKEND (SEPARATE SQL FILE)
        // =============================================

        // ---------- SUPABASE CONFIGURATION ----------
        // REPLACE WITH YOUR ACTUAL SUPABASE PROJECT URL AND ANON KEY
        const SUPABASE_URL = "https://gtqlewymsfwhjipcpxlg.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0cWxld3ltc2Z3aGppcGNweGxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MzU5MzIsImV4cCI6MjA4NjMxMTkzMn0.J0NxvpzJTyR--pUNxVWqnegeQmwVSRKEveamS8ZYJEM";
        
        // Set to true when you have configured your Supabase project
        const USE_SUPABASE = false; // CHANGE TO true AFTER BACKEND SETUP
        
        // ---------- APP STATE ----------
        let supabase = null;
        let selectedSeverity = 'critical';
        
        // Mock data for testing (when Supabase is disabled)
        let mockAlerts = [
            {
                id: '101',
                message: '‚ö†Ô∏è Severe weather warning in effect until 6 PM.',
                severity: 'critical',
                sender: 'weather-svc',
                created_at: new Date(Date.now() - 1000*60*8).toISOString()
            },
            {
                id: '102',
                message: 'VPN maintenance scheduled for 22:00.',
                severity: 'warning',
                sender: 'it-security',
                created_at: new Date(Date.now() - 1000*60*32).toISOString()
            },
            {
                id: '103',
                message: 'New visitor policy announced.',
                severity: 'info',
                sender: 'facilities',
                created_at: new Date(Date.now() - 1000*60*125).toISOString()
            }
        ];

        // DOM elements
        const messageInput = document.getElementById('alertMessage');
        const severityOpts = document.querySelectorAll('.type-option');
        const publishBtn = document.getElementById('publishAlertBtn');
        const feedDiv = document.getElementById('alertFeed');
        const toastDiv = document.getElementById('pushToast');
        const refreshBtn = document.getElementById('refreshFeedBtn');

        // ---------- UTILITIES ----------
        function escapeHTML(text) {
            return String(text).replace(/[&<>"]/g, function(c) {
                if(c === '&') return '&amp;';
                if(c === '<') return '&lt;';
                if(c === '>') return '&gt;';
                if(c === '"') return '&quot;';
                return c;
            });
        }

        function showPushNotification(message, severity) {
            toastDiv.classList.remove('hidden');
            let icon = 'üîî';
            if (severity === 'critical') icon = 'üö® CRITICAL';
            else if (severity === 'warning') icon = '‚ö†Ô∏è WARNING';
            else icon = 'üì¢ INFO';
            toastDiv.innerHTML = `<i class="fas fa-bell" style="margin-right: 10px;"></i> ${icon}: ${escapeHTML(message.substring(0, 60))}${message.length > 60 ? '‚Ä¶' : ''}`;
            setTimeout(() => toastDiv.classList.add('hidden'), 5000);
        }

        // ---------- RENDER ALERT FEED ----------
        function renderAlerts(alerts) {
            if (!alerts || alerts.length === 0) {
                feedDiv.innerHTML = `<div class="empty-state">
                    <i class="fas fa-bell-slash" style="font-size: 2.8rem; margin-bottom: 18px; opacity: 0.6;"></i>
                    <p style="font-size: 1.2rem; font-weight: 600;">No active broadcasts</p>
                    <p style="margin-top: 10px;">Alerts appear instantly, even when app is closed.</p>
                </div>`;
                return;
            }

            const sorted = [...alerts].sort((a,b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );

            let html = '';
            sorted.forEach(alert => {
                let cardClass = '', badgeClass = '', icon = '';
                if (alert.severity === 'critical') {
                    cardClass = 'alert-critical';
                    badgeClass = 'critical-badge';
                    icon = 'fa-bolt';
                } else if (alert.severity === 'warning') {
                    cardClass = 'alert-warning';
                    badgeClass = 'warning-badge';
                    icon = 'fa-exclamation';
                } else {
                    cardClass = 'alert-info';
                    badgeClass = 'info-badge';
                    icon = 'fa-info';
                }

                const date = new Date(alert.created_at);
                const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = date.toLocaleDateString([], { month: 'short', day: 'numeric' });

                html += `<div class="alert-card ${cardClass}">
                    <div class="alert-header">
                        <span class="alert-badge ${badgeClass}">
                            <i class="fas ${icon}"></i> ${alert.severity.toUpperCase()}
                        </span>
                        <span class="alert-timestamp">
                            <i class="far fa-clock"></i> ${dateStr}, ${time}
                        </span>
                    </div>
                    <div class="alert-message">
                        ${escapeHTML(alert.message)}
                    </div>
                    <div class="alert-footer">
                        <span class="sender">
                            <i class="fas fa-user-cog"></i> ${escapeHTML(alert.sender || 'dispatch')}
                        </span>
                        <span style="display: flex; gap: 8px;">
                            <i class="fas fa-rss"></i> live
                        </span>
                    </div>
                </div>`;
            });
            feedDiv.innerHTML = html;
        }

        // ---------- FETCH ALERTS (Supabase or mock) ----------
        async function fetchAlerts() {
            if (USE_SUPABASE && supabase) {
                try {
                    const { data, error } = await supabase
                        .from('alerts')
                        .select('*')
                        .order('created_at', { ascending: false });
                    if (error) throw error;
                    renderAlerts(data);
                } catch (err) {
                    console.error('Supabase fetch error, using mock:', err);
                    renderAlerts(mockAlerts);
                }
            } else {
                renderAlerts(mockAlerts);
            }
        }

        // ---------- PUBLISH NEW ALERT ----------
        async function publishAlert(message, severity) {
            if (!message.trim()) {
                alert('Please enter an alert message.');
                return;
            }

            const sender = 'web-console'; // fixed sender for simplicity

            if (USE_SUPABASE && supabase) {
                try {
                    const { data, error } = await supabase
                        .from('alerts')
                        .insert([{ 
                            message: message.trim(), 
                            severity, 
                            sender,
                            created_at: new Date().toISOString()
                        }])
                        .select();
                    if (error) throw error;
                    showPushNotification(message, severity);
                    fetchAlerts(); // refresh feed
                } catch (err) {
                    console.error('Supabase insert error, using mock fallback:', err);
                    addMockAlert(message, severity, sender);
                }
            } else {
                addMockAlert(message, severity, sender);
            }
            messageInput.value = '';
        }

        function addMockAlert(message, severity, sender) {
            const newAlert = {
                id: String(Date.now()),
                message: message.trim(),
                severity,
                sender,
                created_at: new Date().toISOString()
            };
            mockAlerts.push(newAlert);
            if (mockAlerts.length > 20) mockAlerts.shift();
            showPushNotification(message, severity);
            renderAlerts(mockAlerts);
        }

        // ---------- INITIALIZE SUPABASE (if enabled) ----------
        async function initSupabase() {
            if (USE_SUPABASE) {
                try {
                    const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2.39.8');
                    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    // Realtime subscription: alerts appear as push messages
                    supabase.channel('public:alerts')
                        .on('postgres_changes', 
                            { event: 'INSERT', schema: 'public', table: 'alerts' }, 
                            (payload) => {
                                const alert = payload.new;
                                showPushNotification(alert.message, alert.severity);
                                fetchAlerts(); // update feed
                            }
                        )
                        .subscribe();
                    console.log('‚úÖ Supabase realtime connected');
                } catch (e) {
                    console.warn('Supabase init failed, running in mock mode', e);
                    window.USE_SUPABASE = false; // fallback
                }
            }
        }

        // ---------- EVENT LISTENERS ----------
        severityOpts.forEach(opt => {
            opt.addEventListener('click', () => {
                severityOpts.forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                selectedSeverity = opt.dataset.type;
            });
        });

        publishBtn.addEventListener('click', () => {
            publishAlert(messageInput.value, selectedSeverity);
        });

        refreshBtn.addEventListener('click', fetchAlerts);

        // ---------- START APP ----------
        window.addEventListener('DOMContentLoaded', async () => {
            await initSupabase();
            await fetchAlerts();
        });
    </script>
</body>
</html>
