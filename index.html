<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>InformaCast Pro - Critical Alert System</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22InformaCast%20Pro%22%2C%22short_name%22%3A%22InformaCast%22%2C%22start_url%22%3A%22%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a2e42%22%2C%22theme_color%22%3A%22%230a5c8c%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F893%2F893257.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a5c8c">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(145deg, #0a2e42 0%, #0c384f 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border-radius: 40px;
            padding: 28px 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 20px 0;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #ffd700;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
        }

        .header p {
            color: #b0d4e8;
            font-size: 1.1em;
        }

        .status-bar {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50px;
            padding: 15px 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
            animation: pulse 2s infinite;
        }

        .dot.warning {
            background: #ffaa33;
            box-shadow: 0 0 10px #ffaa33;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .install-btn {
            background: #ffd700;
            color: #0a2e42;
            border: none;
            border-radius: 30px;
            padding: 15px 25px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin: 15px 0;
            transition: transform 0.2s;
        }

        .install-btn:hover {
            transform: translateY(-2px);
        }

        .alert-creator {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 25px;
            margin: 25px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        textarea {
            width: 100%;
            padding: 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #ffd700;
        }

        .severity-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .severity-btn {
            flex: 1;
            min-width: 100px;
            padding: 15px;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.7;
        }

        .severity-btn.active {
            opacity: 1;
            transform: scale(1.02);
            box-shadow: 0 0 20px currentColor;
        }

        .critical-btn {
            background: #ff4444;
            color: white;
        }

        .warning-btn {
            background: #ffaa33;
            color: #0a2e42;
        }

        .info-btn {
            background: #4caf50;
            color: white;
        }

        .send-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(145deg, #ffd700, #ffb300);
            border: none;
            border-radius: 50px;
            color: #0a2e42;
            font-weight: bold;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }

        .alerts-section {
            margin-top: 30px;
        }

        .alerts-section h3 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-card {
            background: rgba(255, 255, 255, 0.1);
            border-left: 5px solid;
            padding: 18px;
            margin-bottom: 12px;
            border-radius: 15px;
            transition: transform 0.2s;
        }

        .alert-card:hover {
            transform: translateX(5px);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .alert-severity {
            font-weight: bold;
        }

        .alert-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9em;
        }

        .alert-message {
            font-size: 1.1em;
            margin: 8px 0;
        }

        .alert-sender {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9em;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ffd700;
            color: #0a2e42;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: bold;
            z-index: 9999;
            animation: slideUp 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from { transform: translate(-50%, 100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš¨ InformaCast Pro</h1>
            <p>Critical Alert & Notification System</p>
        </div>

        <div class="status-bar" id="statusBar">
            <span class="dot" id="statusDot"></span>
            <span id="statusText">Checking notification permissions...</span>
        </div>

        <button id="installBtn" class="install-btn hidden">
            ðŸ“² Install App on Home Screen
        </button>

        <div class="alert-creator">
            <h3 style="margin-bottom: 15px;">ðŸ“¢ Create New Alert</h3>
            <textarea id="messageInput" placeholder="Enter alert message..." rows="3"></textarea>
            
            <div class="severity-selector" id="severitySelector">
                <button class="severity-btn critical-btn active" data-severity="critical">ðŸ”´ CRITICAL</button>
                <button class="severity-btn warning-btn" data-severity="warning">ðŸŸ  WARNING</button>
                <button class="severity-btn info-btn" data-severity="info">ðŸ”µ INFO</button>
            </div>

            <button id="sendBtn" class="send-btn">
                ðŸ“¢ SEND PUSH ALERT
            </button>
        </div>

        <div class="alerts-section">
            <h3>
                <span>ðŸ“‹ Recent Alerts</span>
                <button id="refreshBtn" style="background: none; border: none; color: white; cursor: pointer;">
                    ðŸ”„
                </button>
            </h3>
            <div id="alertsList">
                <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.5);">
                    <i class="fas fa-circle-notch fa-spin"></i> Loading alerts...
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION - UPDATE WITH YOUR SUPABASE INFO
        // =============================================
        const SUPABASE_URL = 'https://zwhbpqhrlkxhgrhmgyvx.supabase.co'; // REPLACE THIS
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3aGJwcWhybGt4aGdyaG1neXZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODUzMDUsImV4cCI6MjA4NjY2MTMwNX0.jPcxT1wZMCbPFQkK4qWhLfQkO8MtvVPlyga1i2cto6o'; // REPLACE THIS

        // =============================================
        // SERVICE WORKER FOR PUSH NOTIFICATIONS
        // =============================================
        const swCode = `
        self.addEventListener('install', (event) => {
            self.skipWaiting();
        });

        self.addEventListener('activate', (event) => {
            event.waitUntil(clients.claim());
        });

        self.addEventListener('push', (event) => {
            if (!event.data) return;
            
            const data = event.data.json();
            
            let title = 'ðŸ“¢ INFO';
            let vibration = [200, 100, 200];
            
            if (data.severity === 'critical') {
                title = 'ðŸš¨ CRITICAL ALERT';
                vibration = [500, 200, 500, 200, 500];
            } else if (data.severity === 'warning') {
                title = 'âš ï¸ WARNING';
                vibration = [300, 100, 300];
            }

            const options = {
                body: data.message,
                icon: 'https://cdn-icons-png.flaticon.com/512/893/893257.png',
                badge: 'https://cdn-icons-png.flaticon.com/512/893/893257.png',
                vibrate: vibration,
                data: { url: '/' },
                requireInteraction: true,
                silent: false
            };

            event.waitUntil(
                self.registration.showNotification(title, options)
            );
        });

        self.addEventListener('notificationclick', (event) => {
            event.notification.close();
            event.waitUntil(
                clients.openWindow('/')
            );
        });
        `;

        // =============================================
        // APP STATE
        // =============================================
        let currentSeverity = 'critical';
        let swRegistration = null;

        // =============================================
        // INITIALIZATION
        // =============================================
        window.addEventListener('load', async () => {
            await setupServiceWorker();
            await loadAlerts();
            setupEventListeners();
            checkInstallPrompt();
        });

        async function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    swRegistration = await navigator.serviceWorker.register(url, { scope: '/' });
                    
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        updateStatus('active', 'Notifications active - Alerts will ring your phone!');
                    } else {
                        updateStatus('warning', 'Notifications blocked - Please enable in settings');
                    }
                } catch (error) {
                    updateStatus('warning', 'Push notifications unavailable');
                }
            }
        }

        function updateStatus(type, message) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            dot.className = 'dot' + (type === 'warning' ? ' warning' : '');
            text.textContent = message;
        }

        async function loadAlerts() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/alerts?order=created_at.desc&limit=20`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch');
                
                const alerts = await response.json();
                displayAlerts(alerts);
            } catch (error) {
                // Show demo data if Supabase not configured
                displayAlerts([
                    {
                        id: '1',
                        message: 'Welcome to InformaCast Pro! Update SUPABASE_URL and SUPABASE_ANON_KEY in the code to connect to your database.',
                        severity: 'info',
                        sender: 'system',
                        created_at: new Date().toISOString()
                    },
                    {
                        id: '2',
                        message: 'Click the CRITICAL button and send a test alert to see push notifications in action!',
                        severity: 'critical',
                        sender: 'system',
                        created_at: new Date(Date.now() - 60000).toISOString()
                    }
                ]);
            }
        }

        function displayAlerts(alerts) {
            const list = document.getElementById('alertsList');
            
            if (!alerts || alerts.length === 0) {
                list.innerHTML = '<p style="text-align: center; padding: 20px;">No alerts yet</p>';
                return;
            }
            
            let html = '';
            alerts.forEach(alert => {
                const time = new Date(alert.created_at).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
                
                const color = alert.severity === 'critical' ? '#ff4444' : 
                             alert.severity === 'warning' ? '#ffaa33' : '#4caf50';
                
                html += `
                    <div class="alert-card" style="border-left-color: ${color}">
                        <div class="alert-header">
                            <span class="alert-severity" style="color: ${color}">${alert.severity.toUpperCase()}</span>
                            <span class="alert-time">${time}</span>
                        </div>
                        <div class="alert-message">${escapeHtml(alert.message)}</div>
                        <div class="alert-sender">From: ${escapeHtml(alert.sender)}</div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        async function sendAlert() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                showToast('âš ï¸ Please enter a message');
                return;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/alerts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        message: message,
                        severity: currentSeverity,
                        sender: 'web-user'
                    })
                });

                if (!response.ok) throw new Error('Failed to send');

                // Show local notification
                if (swRegistration && Notification.permission === 'granted') {
                    await swRegistration.showNotification(
                        currentSeverity === 'critical' ? 'ðŸš¨ CRITICAL' : 
                        currentSeverity === 'warning' ? 'âš ï¸ WARNING' : 'ðŸ“¢ INFO',
                        {
                            body: message,
                            icon: 'https://cdn-icons-png.flaticon.com/512/893/893257.png',
                            vibrate: currentSeverity === 'critical' ? [500,200,500] : [200,100,200],
                            requireInteraction: true
                        }
                    );
                }

                document.getElementById('messageInput').value = '';
                await loadAlerts();
                showToast('âœ… Alert sent!');
                
            } catch (error) {
                console.error('Send error:', error);
                showToast('âŒ Failed to send. Check Supabase configuration.');
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setupEventListeners() {
            // Severity selector
            document.querySelectorAll('.severity-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSeverity = btn.dataset.severity;
                });
            });

            // Send button
            document.getElementById('sendBtn').addEventListener('click', sendAlert);

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadAlerts);

            // Enter key in textarea
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAlert();
                }
            });
        }

        function checkInstallPrompt() {
            // PWA install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                const installBtn = document.getElementById('installBtn');
                installBtn.classList.remove('hidden');
                installBtn.onclick = async () => {
                    e.prompt();
                    const { outcome } = await e.userChoice;
                    if (outcome === 'accepted') {
                        installBtn.classList.add('hidden');
                    }
                };
            });

            // Hide install button if already installed
            if (window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('installBtn').classList.add('hidden');
            }
        }

        // Auto-refresh alerts every 10 seconds
        setInterval(loadAlerts, 10000);
    </script>
</body>
</html>
