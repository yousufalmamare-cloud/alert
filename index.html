<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>InformaCast Cloud - Global Alert System</title>
    
    <!-- OneSignal SDK for cross-platform push -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
        }

        .header h1 i {
            color: #667eea;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            display: inline-block;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .status-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .status-icon.success { background: #d4edda; color: #155724; }
        .status-icon.warning { background: #fff3cd; color: #856404; }
        .status-icon.info { background: #e7f3ff; color: #004085; }

        .status-content h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .status-content p {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Alert Creator Card */
        .alert-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .alert-card h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .severity-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .severity-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.7;
            font-size: 1em;
        }

        .severity-btn.active {
            opacity: 1;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .critical-btn { background: #dc3545; color: white; }
        .warning-btn { background: #ffc107; color: #333; }
        .info-btn { background: #17a2b8; color: white; }

        .send-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Device Info Card */
        .device-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .device-card h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }

        .player-id {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9em;
            word-break: break-all;
        }

        /* Alerts Feed */
        .feed-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .feed-card h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .refresh-btn {
            background: #f8f9fa;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-weight: 600;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #e9ecef;
        }

        .alert-item {
            background: #f8f9fa;
            border-left: 5px solid;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 10px;
            transition: transform 0.2s;
        }

        .alert-item:hover {
            transform: translateX(5px);
        }

        .alert-item.critical { border-left-color: #dc3545; }
        .alert-item.warning { border-left-color: #ffc107; }
        .alert-item.info { border-left-color: #17a2b8; }

        .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .alert-severity {
            font-weight: 700;
        }

        .alert-time {
            color: #999;
            font-size: 0.9em;
        }

        .alert-message {
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #333;
        }

        .alert-sender {
            color: #666;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            color: #333;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-left: 4px solid #28a745; }
        .toast.error { border-left: 4px solid #dc3545; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading i {
            font-size: 2em;
            margin-bottom: 10px;
            color: #667eea;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 25px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .footer i {
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-cloud-upload-alt"></i> InformaCast Cloud
            </h1>
            <p>Global Push Notification System â€¢ Works on Any Device â€¢ Real-time Alerts</p>
            <div class="badge">
                <i class="fas fa-globe-americas"></i> Connected to Cloud
            </div>
        </div>

        <!-- Status Dashboard -->
        <div class="status-grid" id="statusGrid">
            <div class="status-card">
                <div class="status-icon info" id="cloudIcon">
                    <i class="fas fa-cloud"></i>
                </div>
                <div class="status-content">
                    <h3>Supabase Cloud</h3>
                    <p id="cloudStatus">Connecting...</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon info" id="pushIcon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="status-content">
                    <h3>OneSignal Push</h3>
                    <p id="pushStatus">Initializing...</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon info" id="deviceIcon">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <div class="status-content">
                    <h3>Your Device</h3>
                    <p id="deviceStatus">Detecting...</p>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Alert Creator -->
            <div class="alert-card">
                <h2>
                    <i class="fas fa-bullhorn" style="color: #667eea;"></i>
                    Create New Alert
                </h2>
                <textarea id="messageInput" placeholder="Enter your alert message..." rows="4">ðŸš¨ Test alert from cloud - This will reach all devices!</textarea>
                
                <div class="severity-selector" id="severitySelector">
                    <button class="severity-btn critical-btn active" data-severity="critical">
                        <i class="fas fa-exclamation-triangle"></i> CRITICAL
                    </button>
                    <button class="severity-btn warning-btn" data-severity="warning">
                        <i class="fas fa-exclamation"></i> WARNING
                    </button>
                    <button class="severity-btn info-btn" data-severity="info">
                        <i class="fas fa-info-circle"></i> INFO
                    </button>
                </div>

                <button id="sendBtn" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                    SEND TO ALL DEVICES
                </button>
            </div>

            <!-- Device Info -->
            <div class="device-card">
                <h2>
                    <i class="fas fa-shield-alt" style="color: #667eea;"></i>
                    Device Registration
                </h2>
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-id-card"></i> OneSignal Player ID
                    </div>
                    <div class="player-id" id="playerId">Waiting for registration...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-laptop"></i> Platform
                    </div>
                    <div class="info-value" id="platform">Detecting...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-bell"></i> Notification Permission
                    </div>
                    <div class="info-value" id="permission">Checking...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-clock"></i> Last Active
                    </div>
                    <div class="info-value" id="lastActive">Just now</div>
                </div>
            </div>
        </div>

        <!-- Alerts Feed -->
        <div class="feed-card">
            <div class="feed-header">
                <h2>
                    <i class="fas fa-history" style="color: #667eea;"></i>
                    Global Alert History
                </h2>
                <button class="refresh-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div id="alertsList">
                <div class="loading">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <p>Loading alerts from cloud...</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>
                <i class="fas fa-globe"></i> Works Anywhere â€¢ 
                <i class="fas fa-mobile-alt"></i> Any Device â€¢ 
                <i class="fas fa-bell"></i> Real Push Notifications
            </p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle" style="color: #28a745;"></i>
        <span id="toastMessage">Alert sent successfully!</span>
    </div>

    <script>
        // =============================================
        // CONFIGURATION - UPDATE WITH YOUR VALUES
        // =============================================
        const SUPABASE_URL = 'https://zwhbpqhrlkxhgrhmgyvx.supabase.co'; // REPLACE WITH YOUR URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3aGJwcWhybGt4aGdyaG1neXZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODUzMDUsImV4cCI6MjA4NjY2MTMwNX0.jPcxT1wZMCbPFQkK4qWhLfQkO8MtvVPlyga1i2cto6o'; // REPLACE WITH YOUR KEY
        
        // OneSignal Configuration - Sign up at https://onesignal.com
        const ONE_SIGNAL_APP_ID = 'YOUR_ONESIGNAL_APP_ID'; // REPLACE WITH YOUR APP ID

        // =============================================
        // APP STATE
        // =============================================
        let currentSeverity = 'critical';
        let oneSignalInitialized = false;
        let playerId = null;

        // =============================================
        // INITIALIZE ONE SIGNAL (CROSS-PLATFORM PUSH)
        // =============================================
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: ONE_SIGNAL_APP_ID,
                safari_web_id: 'web.onesignal.auto.' + ONE_SIGNAL_APP_ID,
                notifyButton: {
                    enable: true,
                    size: 'large',
                    position: 'bottom-right',
                    prenotify: true,
                    showCredit: false,
                    text: {
                        'tip.state.unsubscribed': 'Get notifications',
                        'tip.state.subscribed': 'You\'re subscribed',
                        'tip.state.blocked': 'You\'ve blocked notifications',
                        'message.prenotify': 'Click to get notifications',
                        'message.action.subscribed': 'Thanks for subscribing!',
                        'message.action.resubscribed': 'You\'re subscribed',
                        'message.action.unsubscribed': 'You won\'t receive notifications',
                        'dialog.main.title': 'Manage Notifications',
                        'dialog.main.button.subscribe': 'SUBSCRIBE',
                        'dialog.main.button.unsubscribe': 'UNSUBSCRIBE',
                        'dialog.blocked.title': 'Unblock Notifications',
                        'dialog.blocked.message': 'Follow these instructions to allow notifications:'
                    }
                },
                allowLocalhostAsSecureOrigin: true,
                serviceWorkerParam: { scope: '/' },
                serviceWorkerPath: 'OneSignalSDKWorker.js',
            });

            // Get device info
            const userId = await OneSignal.getUserId();
            const subscription = await OneSignal.getSubscription();
            
            if (userId) {
                playerId = userId;
                document.getElementById('playerId').textContent = userId;
                document.getElementById('platform').textContent = getPlatform();
                
                // Save to Supabase
                await saveDeviceToSupabase(userId);
                
                // Update status
                document.getElementById('pushStatus').textContent = 'Connected';
                document.getElementById('pushIcon').className = 'status-icon success';
                document.getElementById('pushIcon').innerHTML = '<i class="fas fa-check"></i>';
                oneSignalInitialized = true;
            }

            // Listen for notification clicks
            OneSignal.addListenerForNotificationOpened(async (notification) => {
                console.log('Notification opened:', notification);
                showToast('Notification opened!', 'success');
                await loadAlerts();
            });
        });

        // =============================================
        // SUPABASE FUNCTIONS
        // =============================================
        async function checkSupabaseConnection() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/alerts?limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    document.getElementById('cloudStatus').textContent = 'Connected';
                    document.getElementById('cloudIcon').className = 'status-icon success';
                    document.getElementById('cloudIcon').innerHTML = '<i class="fas fa-check"></i>';
                    return true;
                }
            } catch (error) {
                console.log('Supabase connection error:', error);
            }
            
            document.getElementById('cloudStatus').textContent = 'Check config';
            document.getElementById('cloudIcon').className = 'status-icon warning';
            document.getElementById('cloudIcon').innerHTML = '<i class="fas fa-exclamation"></i>';
            return false;
        }

        async function saveDeviceToSupabase(pid) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/devices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        player_id: pid,
                        device_type: getPlatform(),
                        platform: navigator.platform,
                        last_active: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.log('Device save error:', error);
            }
        }

        async function loadAlerts() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/alerts?order=created_at.desc&limit=20`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                const alerts = await response.json();
                displayAlerts(alerts);
            } catch (error) {
                document.getElementById('alertsList').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                        <p>Error loading alerts. Check Supabase configuration.</p>
                    </div>
                `;
            }
        }

        function displayAlerts(alerts) {
            const list = document.getElementById('alertsList');
            
            if (!alerts || alerts.length === 0) {
                list.innerHTML = '<div class="loading"><p>No alerts yet</p></div>';
                return;
            }

            list.innerHTML = alerts.map(alert => {
                const severityClass = alert.severity === 'critical' ? 'critical' : 
                                     alert.severity === 'warning' ? 'warning' : 'info';
                
                return `
                    <div class="alert-item ${severityClass}">
                        <div class="alert-header">
                            <span class="alert-severity">${alert.severity.toUpperCase()}</span>
                            <span class="alert-time">
                                ${new Date(alert.created_at).toLocaleString()}
                            </span>
                        </div>
                        <div class="alert-message">${escapeHtml(alert.message)}</div>
                        <div class="alert-sender">
                            <i class="fas fa-user-circle"></i> ${escapeHtml(alert.sender)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =============================================
        // SEND ALERT FUNCTION
        // =============================================
        async function sendAlert() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                showToast('Please enter a message', 'error');
                return;
            }

            const sendBtn = document.getElementById('sendBtn');
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> SENDING...';
            sendBtn.disabled = true;

            try {
                // Save to Supabase
                const response = await fetch(`${SUPABASE_URL}/rest/v1/alerts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        message: message,
                        severity: currentSeverity,
                        sender: 'cloud-operator'
                    })
                });

                if (!response.ok) throw new Error('Failed to save');

                // Show success
                showToast('âœ… Alert sent to all devices!', 'success');
                document.getElementById('messageInput').value = '';
                await loadAlerts();

                // Show local notification for testing
                if (Notification.permission === 'granted') {
                    new Notification(
                        currentSeverity === 'critical' ? 'ðŸš¨ CRITICAL ALERT' :
                        currentSeverity === 'warning' ? 'âš ï¸ WARNING' : 'ðŸ“¢ INFO',
                        {
                            body: message,
                            icon: 'https://cdn-icons-png.flaticon.com/512/893/893257.png'
                        }
                    );
                }

            } catch (error) {
                console.error('Send error:', error);
                showToast('âŒ Error sending alert', 'error');
            } finally {
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = false;
            }
        }

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================
        function getPlatform() {
            const ua = navigator.userAgent;
            if (/iPhone|iPad|iPod/i.test(ua)) return 'ðŸ“± iOS';
            if (/Android/i.test(ua)) return 'ðŸ“± Android';
            if (/Mac/i.test(ua)) return 'ðŸ’» macOS';
            if (/Windows/i.test(ua)) return 'ðŸ’» Windows';
            if (/Linux/i.test(ua)) return 'ðŸ’» Linux';
            return 'ðŸŒ Web';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const icon = toast.querySelector('i');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
                icon.style.color = '#28a745';
            } else {
                icon.className = 'fas fa-exclamation-circle';
                icon.style.color = '#dc3545';
            }
            
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        async function updateDeviceInfo() {
            // Check notification permission
            if (Notification.permission === 'granted') {
                document.getElementById('permission').textContent = 'âœ… Allowed';
            } else if (Notification.permission === 'denied') {
                document.getElementById('permission').textContent = 'âŒ Blocked';
            } else {
                document.getElementById('permission').textContent = 'âš ï¸ Not requested';
            }

            // Update device type
            document.getElementById('deviceStatus').textContent = getPlatform();
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================
        document.querySelectorAll('.severity-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSeverity = btn.dataset.severity;
            });
        });

        document.getElementById('sendBtn').addEventListener('click', sendAlert);

        document.getElementById('refreshBtn').addEventListener('click', loadAlerts);

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAlert();
            }
        });

        // =============================================
        // INITIALIZATION
        // =============================================
        window.addEventListener('load', async () => {
            await checkSupabaseConnection();
            await loadAlerts();
            await updateDeviceInfo();
            
            // Auto-refresh every 10 seconds
            setInterval(loadAlerts, 10000);
        });
    </script>
</body>
</html>
